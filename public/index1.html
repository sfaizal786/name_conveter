<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CSV Email Generator — Modern UI</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: linear-gradient(135deg, #6b21a8, #3b82f6);
      margin: 0;
      padding: 40px 20px;
      color: #1f2937;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .container {
      max-width: 960px;
      margin: auto;
      background: linear-gradient(135deg, #bcc0e5, #384253);
      padding: 32px 40px;
      border-radius: 20px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
      color: #1f2937;
      width: 100%;
      box-sizing: border-box;
    }

    h1 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    p.lead {
      font-size: 14px;
      color: #6b7280;
      margin-top: 0;
      margin-bottom: 24px;
    }

    label {
      display: block;
      font-weight: 600;
      margin-top: 20px;
      margin-bottom: 6px;
    }

    input[type=text], select, input[type=file] {
      width: 100%;
      padding: 10px 12px;
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      background: #fff;
      transition: 0.2s ease;
    }

    input[type=text]:focus, select:focus, input[type=file]:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 12px;
    }

    .col {
      flex: 1;
      min-width: 280px;
    }

    .controls {
      margin-top: 24px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    button {
      padding: 10px 18px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      border: none;
      transition: 0.2s ease;
    }

    button#generateBtn {
      background: #2563eb;
      color: white;
    }

    button.secondary {
      background: #10b981;
      color: white;
    }

    button.ghost {
      background: #f3f4f6;
      color: #1f2937;
    }

    button:hover {
      opacity: 0.9;
    }

    .preset-item {
      display: flex;
      align-items: center;
      gap: 6px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 14px;
    }

    .preset-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .meta {
      font-size: 13px;
      color: #6b7280;
      margin-top: 8px;
    }

    .error {
      color: #dc2626;
      font-size: 14px;
      margin-top: 12px;
    }

    .preview-box {
      margin-top: 20px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px;
      overflow-x: auto;
      max-height: 360px;
      background: #fdfdfd;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th, td {
      padding: 8px 12px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }

    thead th {
      background: #f3f4f6;
      font-weight: 600;
    }

    ul {
      margin-top: 0;
      padding-left: 16px;
      font-size: 13px;
      color: #4b5563;
    }

    .small {
      font-size: 13px;
      color: #6b7280;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>CSV Email Generator</h1>
    <p class="lead">Upload a CSV with <strong>first_name</strong>, <strong>last_name</strong>, and <strong>company_domain</strong>. We'll generate emails based on presets or your custom format.</p>

    <label>Upload CSV</label>
    <input id="csvFile" type="file" accept=".csv,text/csv" />
    <div id="parsedHeaders" class="meta">No file uploaded yet.</div>

    <div class="row">
      <div class="col">
        <label>Email Format</label>
        <select id="presetSelect"></select>
        <input id="formatInput" type="text" value="{first}.{last}@{domain}" placeholder="Custom format e.g. {first}.{last}@{domain}" />
        <div class="small">Placeholders: <code>{first}</code>, <code>{last}</code>, <code>{f}</code>, <code>{l}</code>, <code>{domain}</code></div>
      </div>
      <div class="col">
        <div class="meta">Using <code>company_domain</code> column from CSV.</div>

        <label style="margin-top:12px">Multiple Presets</label>
        <div class="preset-list" id="presetCheckboxes"></div>

        <div style="margin-top:8px" class="small">
          <button id="selectAllPresets">Select all</button>
          <button id="clearPresets">Clear</button>
        </div>
      </div>
    </div>

    <div class="controls">
      <button id="generateBtn">Generate</button>
      <button id="downloadBtn" class="secondary">Download CSV</button>
      <button id="resetBtn" class="ghost">Reset</button>
    </div>

    <div id="error" class="error" role="status" aria-live="polite"></div>

    <h3 style="margin-top:24px;margin-bottom:8px">Preview (First 20 Rows)</h3>
    <div class="preview-box">
      <div id="previewArea">No preview. Click Generate.</div>
    </div>

    <div style="margin-top:24px;font-size:13px;color:#666">
      <strong>Example formats:</strong>
      <ul>
        <li><code>{first}.{last}@{domain}</code> → john.doe@example.com</li>
        <li><code>{f}{last}@{domain}</code> → jdoe@example.com</li>
        <li><code>{first}_{last}@{domain}</code> → john_doe@example.com</li>
        <li><code>{first}{l}@{domain}</code> → johnd@example.com</li>
      </ul>
    </div>

    <div style="margin-top:24px;font-size:12px;color:#9ca3af">
      This tool uses PapaParse (CDN) to parse CSV files in-browser.
    </div>
  </div>

  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const PRESETS = [
      { id: 'first_dot_last', label: '{first}.{last}@{domain}', format: '{first}.{last}@{domain}' },
      { id: 'f_last', label: '{f}{last}@{domain}', format: '{f}{last}@{domain}' },
      { id: 'first_underscore_last', label: '{first}_{last}@{domain}', format: '{first}_{last}@{domain}' },
      { id: 'first_last_initial', label: '{first}{l}@{domain}', format: '{first}{l}@{domain}' },
      { id: 'last_dot_first', label: '{last}.{first}@{domain}', format: '{last}.{first}@{domain}' },
      { id: 'first', label: '{first}@{domain}', format: '{first}@{domain}' },
      { id: 'last', label: '{last}@{domain}', format: '{last}@{domain}' }
    ];

    function findNameFields(headers) {
      return {
        first: headers.includes('first_name') ? 'first_name' : null,
        last: headers.includes('last_name') ? 'last_name' : null,
        domain: headers.includes('company_domain') ? 'company_domain' : null
      };
    }

    function normalizeForEmail(s) {
      if (s === undefined || s === null) return '';
      let t = String(s).trim().toLowerCase();
      try {
        t = t.normalize('NFKD').replace(/\p{Diacritic}/gu, '');
      } catch (e) {}
      t = t.replace(/[^a-z0-9]+/gi, '.');
      t = t.replace(/\.+/g, '.');
      t = t.replace(/^\.|\.$/g, '');
      return t;
    }

    function generateEmailFromFormat(formatStr, first, last, domainStr) {
      const f = normalizeForEmail(first);
      const l = normalizeForEmail(last);
      const firstInitial = f ? f[0] : '';
      const lastInitial = l ? l[0] : '';
      return formatStr
        .replace(/\{first\}/gi, f)
        .replace(/\{last\}/gi, l)
        .replace(/\{f\}/gi, firstInitial)
        .replace(/\{l\}/gi, lastInitial)
        .replace(/\{domain\}/gi, domainStr || '');
    }

    let parsedRows = [];
    let parsedHeaders = [];

    const fileInput = document.getElementById('csvFile');
    const parsedHeadersEl = document.getElementById('parsedHeaders');
    const presetSelect = document.getElementById('presetSelect');
    const formatInput = document.getElementById('formatInput');
    const generateBtn = document.getElementById('generateBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const resetBtn = document.getElementById('resetBtn');
    const errorEl = document.getElementById('error');
    const previewArea = document.getElementById('previewArea');
    const presetCheckboxes = document.getElementById('presetCheckboxes');
    const selectAllPresetsBtn = document.getElementById('selectAllPresets');
    const clearPresetsBtn = document.getElementById('clearPresets');

    function initPresets() {
      PRESETS.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.format;
        opt.textContent = p.label;
        presetSelect.appendChild(opt);

        const wrap = document.createElement('label');
        wrap.className = 'preset-item';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.value = p.format;
        cb.dataset.id = p.id;
        const span = document.createElement('span');
        span.textContent = p.label;
        wrap.appendChild(cb);
        wrap.appendChild(span);
        presetCheckboxes.appendChild(wrap);
      });

      presetSelect.addEventListener('change', () => {
        formatInput.value = presetSelect.value;
      });
    }

    initPresets();

    fileInput.addEventListener('change', (e) => {
      errorEl.textContent = '';
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete(results) {
          if (results.errors && results.errors.length) {
            errorEl.textContent = results.errors[0].message || '';
          }
          parsedRows = results.data || [];
          parsedHeaders = results.meta?.fields || [];
          parsedHeadersEl.textContent = parsedHeaders.length ? parsedHeaders.join(', ') : 'No headers found';
          previewArea.innerHTML = 'File parsed. Click Generate to create emails.';
        },
        error(err) {
          errorEl.textContent = 'Error parsing CSV: ' + String(err);
        }
      });
    });

    generateBtn.addEventListener('click', () => {
      errorEl.textContent = '';
      if (!parsedRows.length) {
        errorEl.textContent = 'No rows to process. Please upload a CSV first.';
        return;
      }

      const nameFields = findNameFields(parsedHeaders);
      if (!nameFields.first || !nameFields.last || !nameFields.domain) {
        errorEl.textContent = "CSV must include 'first_name', 'last_name', and 'company_domain' headers.";
        return;
      }

      const checked = Array.from(presetCheckboxes.querySelectorAll('input[type=checkbox]:checked')).map(i => i.value);
      const formatsToUse = checked.length ? checked : [ formatInput.value.trim() ];

      const generated = parsedRows.map(r => {
        const first = r[nameFields.first] ?? '';
        const last = r[nameFields.last] ?? '';
        const domain = r[nameFields.domain] ?? '';
        const out = { ...r };
        formatsToUse.forEach(fmt => {
          const col = 'email_' + fmt.replace(/[^a-z0-9]/gi, '_').replace(/_+/g, '_');
          out[col] = generateEmailFromFormat(fmt, first, last, domain);
        });
        return out;
      });

      parsedRows = generated;

      const preview = generated.slice(0, 20);
      if (!preview.length) {
        previewArea.innerHTML = 'No rows to preview.';
        return;
      }

      const keys = Object.keys(preview[0]);
      let html = '<table><thead><tr>' + keys.map(k => '<th>' + escapeHtml(k) + '</th>').join('') + '</tr></thead><tbody>';
      preview.forEach(row => {
        html += '<tr>' + keys.map(k => '<td>' + escapeHtml(String(row[k] ?? '')) + '</td>').join('') + '</tr>';
      });
      html += '</tbody></table>';
      previewArea.innerHTML = html;
    });

    downloadBtn.addEventListener('click', () => {
      errorEl.textContent = '';
      if (!parsedRows.length) {
        errorEl.textContent = 'No data to download. Generate emails first.';
        return;
      }
      try {
        const csv = Papa.unparse(parsedRows);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'emails_generated.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (e) {
        errorEl.textContent = 'Failed to prepare CSV for download: ' + String(e);
      }
    });

    resetBtn.addEventListener('click', () => {
      parsedRows = [];
      parsedHeaders = [];
      fileInput.value = '';
      parsedHeadersEl.textContent = 'No file uploaded yet.';
      previewArea.innerHTML = 'No preview. Click Generate.';
      errorEl.textContent = '';
      formatInput.value = '{first}.{last}@{domain}';
      presetCheckboxes.querySelectorAll('input[type=checkbox]').forEach(cb => cb.checked = false);
    });

    selectAllPresetsBtn.addEventListener('click', () => {
      presetCheckboxes.querySelectorAll('input[type=checkbox]').forEach(cb => cb.checked = true);
    });

    clearPresetsBtn.addEventListener('click', () => {
      presetCheckboxes.querySelectorAll('input[type=checkbox]').forEach(cb => cb.checked = false);
    });

    function escapeHtml(s) {
      return s.replace(/[&<>\"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]));
    }
  </script>
</body>
</html>

